<div class="rounded-2xl border border-slate-200/70 bg-white/80 backdrop-blur shadow-sm overflow-hidden">
  <div class="p-5 border-b border-slate-200/70 flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6">
    <div class="flex-1">
      <h2 class="text-base font-semibold">WBS</h2>
      <p class="text-xs text-slate-600">Configure WBS values. Edit cells, add/delete rows, then submit.</p>
    </div>
    <div class="w-full sm:w-72">
      <label for="wbsSelect" class="sr-only">Select WBS</label>
      <select id="wbsSelect" class="w-full rounded-xl border-slate-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400"
              [value]="selectedWbs()" (change)="onWbsChange($any($event.target).value)">
        @for (w of wbsOptions; track w) { <option [value]="w">{{ w }}</option> }
      </select>
    </div>
  </div>

  <div class="p-5 overflow-x-auto">
    <div class="mb-3 flex items-center gap-2">
      <button type="button" (click)="addRow()" class="inline-flex items-center gap-2 rounded-lg bg-slate-900 text-white px-3 py-2 text-sm font-medium hover:bg-slate-800">Add row</button>
    </div>

    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-slate-600 border-b border-slate-200/70">
          <th class="py-2 px-2">#</th>
          @for (c of columns; track c.key) {
            <th class="py-2 px-2 whitespace-nowrap">{{ c.label }}</th>
          }
          <th class="py-2 px-2"></th>
        </tr>
      </thead>
      <tbody>
        @for (row of rows(); track row.id) {
          <tr class="border-b border-slate-100/80">
            <td class="py-2 px-2 text-slate-500">{{ row.id }}</td>
            @for (c of columns; track c.key) {
              <td class="py-2 px-2">
                @if (c.key === 'isParent') {
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" [checked]="row.isParent === true" (change)="onCheckboxChange(row.id, 'isParent', $any($event.target).checked)" />
                    <span class="text-xs text-slate-600">Is parent</span>
                  </label>
                } @else if (c.key === 'tow') {
                  <select class="w-44 rounded-lg border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.tow ?? ''" (change)="onSelectChange(row.id, 'tow', $any($event.target).value)">
                    <option [value]="''">Select ToW</option>
                    @for (opt of towOptions; track opt) { <option [value]="opt">{{ opt }}</option> }
                  </select>
                } @else if (c.key === 'country') {
                  <select class="w-44 rounded-lg border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.country ?? ''" (change)="onSelectChange(row.id, 'country', $any($event.target).value)">
                    <option [value]="''">Select country</option>
                    @for (opt of countryOptions; track opt) { <option [value]="opt">{{ opt }}</option> }
                  </select>
                } @else if (c.key === 'parentWbs') {
                  <select [disabled]="row.isParent === true" [class]="'w-44 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 border ' + (row.isParent ? 'bg-slate-100 text-slate-400 border-slate-200' : 'bg-white border-slate-200 focus:ring-primary-300')" [value]="row.parentWbs ?? ''" (change)="onSelectChange(row.id, 'parentWbs', $any($event.target).value)">
                    <option [value]="''">None</option>
                    @for (opt of parentWbsOptions(); track opt) { <option [value]="opt">{{ opt }}</option> }
                  </select>
                } @else if (c.key === 'name') {
                  <input type="text" class="w-44 rounded-lg border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.name ?? ''" (input)="onCellChange(row.id, 'name', $any($event.target).value)" />
                } @else if (c.key === 'code') {
                  <input type="text" class="w-44 rounded-lg border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.code ?? ''" (input)="onCellChange(row.id, 'code', $any($event.target).value)" />
                } @else if (c.key === 'priority') {
                  <input type="number" class="w-44 rounded-lg border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.priority ?? ''" (input)="onCellChange(row.id, 'priority', $any($event.target).value)" />
                } @else if (c.key === 'cci') {
                  <input type="number" class="w-44 rounded-lg border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.cci ?? ''" (input)="onCellChange(row.id, 'cci', $any($event.target).value)" />
                } @else if (c.key === 'revenue') {
                  <input type="number" class="w-44 rounded-lg border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-300" [value]="row.revenue ?? ''" (input)="onCellChange(row.id, 'revenue', $any($event.target).value)" />
                }
              </td>
            }
            <td class="py-2 px-2 text-right">
              <button type="button" (click)="deleteRow(row.id)" class="text-slate-500 hover:text-red-600">Delete</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="p-5 border-t border-slate-200/70 flex items-center justify-between gap-3">
    <div class="text-xs text-slate-600">WBS: <span class="font-medium text-slate-900">{{ selectedWbs() }}</span> Â· Rows: <span class="font-medium text-slate-900">{{ rows().length }}</span></div>
    <button type="button" (click)="submit()" [disabled]="submitting()" class="inline-flex items-center gap-2 rounded-xl bg-primary-600 text-white px-4 py-2.5 text-sm font-semibold shadow-sm hover:bg-primary-700 disabled:opacity-60 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-400">Submit</button>
  </div>

  @if (toastMessage()) {
    <div class="p-5 pt-0">
      <div [class]="'rounded-xl px-4 py-3 text-sm ' + (toastType() === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200')">{{ toastMessage() }}</div>
    </div>
  }
</div>
